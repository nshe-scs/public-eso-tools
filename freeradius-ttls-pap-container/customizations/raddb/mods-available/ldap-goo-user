# Modified so anything starting with FR_ is automagically set based on container env vars
# Designed for use with Google's Secure LDAP service - securely bind with Google-issued LDAP client
# credentials (cert/key pair), then send the actual user's credentials in cleartext.
#
# More information:
#  https://www.freeradius.org/documentation/freeradius-server/3.2.8/concepts/modules/ldap/authentication.html
#  https://support.google.com/cloudidentity/answer/9089736?hl=en&ref_topic=9173976#zippy=%2Cfreeradius
#  https://support.google.com/a/answer/9188164?sjid=17329060464896445123-NC
#  https://support.google.com/a/answer/9167101?hl=en
#
# This mod is called if the container's environment specified to use user matching, not group matching

ldap {
    # Next line replaced by one or more server = ldap_hostname lines by entrypoint script
    FR_LDAP_FQDN_BLOCK

    # Port 389 is LDAP, 636 is LDAPS.
    port = FR_LDAP_SEC_PORT

    # Bind user credentials: generate these at Google in your LDAP client settings
    identity = 'FR_LDAP_BIND_USER'
    password = 'FR_LDAP_BIND_PASS'

    # dn from which all searches will start
    base_dn = 'FR_LDAP_BASEDN'

    # Name of the attribute that contains the user DN.
    # The default name is LDAP-UserDn.
    user_dn = "LDAP-UserDn"

    # User lookups
    user {
        # Find the user (we don't care what groups they're in)
        base_dn = "${..base_dn}"
        filter = "(uid=%{Stripped-User-Name})"
        scope = 'sub'
        access_positive = yes
    }

    group {
    }
    profile {
    }
    client {
    }

    options {
        chase_referrals = yes
        rebind = yes
        res_timeout = 10
        srv_timelimit = 3
        net_timeout = 1
        idle = 120 # to match pool's idle_timeout
        probes = 3
        interval = 3
        ldap_debug = FR_LDAP_DEBUG_LVL
    }

    tls {
        start_tls = no
        certificate_file = ${certdir}/google.pem
        private_key_file = ${certdir}/google.key
        require_cert    = "demand" # google says "allow", but we're strict
        tls_min_version = "1.2"
        tls_max_version = "1.3"
        cipher_list = "DEFAULT"
    }

    # Pool settings tuned to help avoid exceeding Google's 4 query/sec quota (rlm_cache also helps)
    # Limited workers, faster and fewer retries
    pool {
        start = 1
        min = 1
        max = 4
        spare = 1
        uses = 0
        retry_delay = 1
        lifetime = 3600
        idle_timeout = 120
        max_retries = 2
    }
}
