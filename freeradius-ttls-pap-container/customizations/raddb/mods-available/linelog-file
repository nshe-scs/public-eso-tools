# Be thoughtful in the details we log, instead of just logging every attribute pair for every
# part of a conversation. We need to retain 90 days of logs for eduroam troubleshooting and
# investigation. We use a made-up "Correlation-Id" to make logs a little easier to follow.
# Entrypoint script determines whether to log via syslog or to a (persistent) file accessible
# outside the container.
#
# Reminders:
# Tmp-String-0 is a random correlation ID for the entire session, useful for grepping.
# Tmp-String-1 is the inner-tunnel failure reason (e.g. why auth failed).
# Tmp-Integer-0 is the timestamp of the first packet in the outer session (not logged).
# Tmp-Integer-1 is the total elapsed time of the outer session, in ms.
# Tmp-Integer-2 is the count of received packets in the outer session.

# Sending an Access-Accept
# Expect to see inner + outer results when debugging, else just the outer result
linelog linelog_send_accept {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Send-%{reply:Packet-Type},\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 Inner-User=%{session-state:Stripped-User-Name},\
 Realm=%{Stripped-User-Domain},\
 Calling-Station-Id=%{Calling-Station-Id},\
 NAS-IP-Address=%{NAS-IP-Address},\
 Client-IP-Address=%{Client-IP-Address},\
 Elapsed-Ms=%{session-state:Tmp-Integer-1},\
 Recv-Pkt-Count=%{session-state:Tmp-Integer-2}\
"
}

# For cache hits
linelog linelog_send_cached_accept {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Send-%{reply:Packet-Type}-Cached,\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 Inner-User=%{session-state:Stripped-User-Name},\
 Realm=%{Stripped-User-Domain},\
 Calling-Station-Id=%{Calling-Station-Id},\
 NAS-IP-Address=%{NAS-IP-Address},\
 Client-IP-Address=%{Client-IP-Address},\
 Elapsed-Ms=%{session-state:Tmp-Integer-1},\
 Recv-Pkt-Count=%{session-state:Tmp-Integer-2}\
"
}

# Sending an Access-Reject
# Expect to see inner + outer results when debugging, else just the outer result
linelog linelog_send_reject {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Send-%{reply:Packet-Type},\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 Inner-User=%{session-state:Stripped-User-Name},\
 Realm=%{Stripped-User-Domain},\
 Calling-Station-Id=%{Calling-Station-Id},\
 NAS-IP-Address=%{NAS-IP-Address},\
 Client-IP-Address=%{Client-IP-Address},\
 Module-Failure=\"%{Module-Failure-Message}\",\
 Inner-Failure=\"%{session-state:Tmp-String-1}\",\
 Elapsed-Ms=%{session-state:Tmp-Integer-1},\
 Recv-Pkt-Count=%{session-state:Tmp-Integer-2}\
"
}

# For cache hits
linelog linelog_send_cached_reject {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Send-%{reply:Packet-Type}-Cached,\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 Inner-User=%{session-state:Stripped-User-Name},\
 Realm=%{Stripped-User-Domain},\
 Calling-Station-Id=%{Calling-Station-Id},\
 NAS-IP-Address=%{NAS-IP-Address},\
 Client-IP-Address=%{Client-IP-Address},\
 Module-Failure=\"%{Module-Failure-Message}\",\
 Inner-Failure=\"%{session-state:Tmp-String-1}\",\
 Elapsed-Ms=%{session-state:Tmp-Integer-1},\
 Recv-Pkt-Count=%{session-state:Tmp-Integer-2}\
"
}

### The following are only for use when debugging

# Forwarding an Access-Request upstream
linelog linelog_send_proxy_request {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Send-Proxy-Request,\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 Realm=%{Stripped-User-Domain},\
 Calling-Station-Id=%{Calling-Station-Id},\
 NAS-IP-Address=%{NAS-IP-Address},\
 Client-IP-Address=%{Client-IP-Address}\
"
}

# Receiving a response to an Access-Request we forwarded
linelog linelog_recv_proxy_response {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Recv-Proxy-%{proxy-reply:Packet-Type},\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 Calling-Station-Id=%{Calling-Station-Id},\
 %{pairs:proxy-reply:}\
"
}

# Receiving an Access-Request from a client (which may be a proxy)
linelog linelog_recv_request {
    filename = /var/log/freeradius/eduroam.log
    format = "\
 %l \
 action=Recv-%{Packet-Type},\
 Correlation-Id=%{control:Tmp-String-0},\
 User-Name=%{User-Name},\
 NAS-IP-Address=%{NAS-IP-Address},\
 Client-IP-Address=%{Client-IP-Address},\
 Calling-Station-Id=%{Calling-Station-Id},\
 NAS-Identifier=%{NAS-Identifier},\
 Operator-Name=%{Operator-Name}\
"
}
