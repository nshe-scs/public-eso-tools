# Based on https://wiki.freeradius.org/guide/eduroam
# Modified so anything starting with FR_ is automagically set based on container env vars
# Only link this config if using ldap (all sql/sqlite references removed)

server eduroam-inner {
        listen {
                type = auth
                ipaddr = *
                port = 18120 # Used for testing only.  Requests proxied internally.
        }

        authorize {
                # Reuse outer server's Correlation-ID
                if (&outer.session-state:Tmp-String-0) {
                        update control {
                               Tmp-String-0 := &outer.session-state:Tmp-String-0
                        }
                }

                # The outer username is considered garbage for authz purposes, but
                # the domain portion of the outer and inner identities must match.
                split_username_nai
                if (noop || (&Stripped-User-Domain && \
                    (&outer.Stripped-User-Domain != &Stripped-User-Domain))) {
                        reject
                }

                # Make the user's real identity available to anything that needs
                # it in the outer server.
                if (&outer.session-state:){
                        update {
                                &outer.session-state:Stripped-User-Name := &Stripped-User-Name
                        }
                }

 
                files # strictly for debugging

                # Next block is per the default mods-available/ldap file's suggestion
                # for authenticating to Active Directory since you need to bind as the user
                # Note that if the client uses an invalid username, you may get an error like
                # "No Auth-Type found: rejecting the user via Post-Auth-Type = Reject" rather
                # than "username not found"
                ldap
                if ((ok || updated) && User-Password && !control:Auth-Type) {
                        update {
                                control:Auth-Type := PAP
                        }
                }
                pap
        }

        # Also for "bind as user" / Active Directory
        authenticate {
                Auth-Type PAP {
                        ldap
                }
        }

        # Logging
        post-auth {
                # Only log inner success if debugging
                if ("FR_VERBOSE_TOGGLE" == "true"){
                        linelog_send_accept
                }

                Post-Auth-Type REJECT {
                        # Copy inner failure to the outer session for logging
                        # Prefer Module-Failure-Message; fall back to Reply-Message; else a static string.
                        update outer.session-state {
                                Tmp-String-1 := "%{%{request:Module-Failure-Message}:-%{%{control:Module-Failure-Message}:-%{%{reply:Reply-Message}:-no reason provided}}}"
                        }

                        # Only log inner failure here if debugging
                        if ("FR_VERBOSE_TOGGLE" == "true"){
                                linelog_send_reject
                        }
                }
        }
}
